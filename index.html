<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>猫の手も借りたい(仮)</title>
    <script src="https://unpkg.com/obniz@3.18.0/obniz.js"></script>
    <style>
      body {
        background-color: #efeee5;

        color: #998e77;

        /*  フォント　OSやバージョンに対応するように　左から優先的に指定 */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;

        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }

      /* メッセージ表示欄*/
      #status {
        font-size: 1.5em;
        font-weight: 600;
        width: 400px;
        box-sizing: border-box;
        margin-bottom: 25px;
        text-align: center;

        background-color: #dfdacc;

        padding: 20px 30px;
        border-radius: 12px;

        box-shadow: 0 4px 12px rgba(153, 142, 119, 0.2);
      }

      /* ボタンの並べ方 */
      .button-container {
        display: flex;
        gap: 15px;
      }

      /* ボタンの中身 */
      .button-container button {
        font-size: 1.2em;
        font-weight: bold;
        width: 210px;
        background-color: #d47e7e;
        color: #ffffff;
        box-sizing: border-box;
        padding: 15px 35px;
        cursor: pointer;
        border: none;
        border-radius: 12px;

        box-shadow: 0 4px 15px rgba(153, 142, 119, 0.3);

        transition: all 0.2s ease-in-out; /* プロパティ変化時のアニメーションに0.2s */
      }

      /* 2種類のボタンを区別
      #startButton {

      }

      #stopButton {

      }
        */

      /* マウスが乗ったとき　無効化されていない場合のみ */
      .button-container button:not(:disabled):hover {
        transform: translateY(-2px); /* 少し浮き上がる */
        box-shadow: 0 6px 20px rgba(153, 142, 119, 0.35);
      }

      /* クリックされた瞬間 */
      .button-container button:not(:disabled):active {
        transform: translateY(1px); /* 少し沈む */
        box-shadow: 0 2px 8px rgba(153, 142, 119, 0.4);
      }

      /* ボタンが無効化されたとき */
      .button-container button:disabled {
        background-color: #e2a99d;
        color: #ffffff;
        opacity: 0.7;
        cursor: not-allowed;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <div id="status">接続中...</div>
    <div class="button-container">
      <button id="startButton" disabled>作業をはじめる</button>
      <button id="stopButton" disabled>作業をおえる</button>
    </div>

    <script>
      const obniz = new Obniz("2061-9919");

      const TOTAL_SOUND_FILES = 15;
      const FILE_PREFIX = "./voice/cat";
      const FILE_SUFFIX = ".mp3";

      const startButton = document.getElementById("startButton");
      const stopButton = document.getElementById("stopButton");
      const statusDiv = document.getElementById("status");

      let isLooping = false;

      function playRandomCatSound() {
        // 1 から TOTAL_SOUND_FILES までのランダムな整数を生成
        const index = Math.floor(Math.random() * TOTAL_SOUND_FILES) + 1;

        // ファイル名を組み立てる
        const soundFile = FILE_PREFIX + index + FILE_SUFFIX;

        // 選ばれたURLで新しいAudioオブジェクトを作成して再生
        const soundToPlay = new Audio(soundFile);
        soundToPlay.play();
      }

      // obnizが接続されたら
      obniz.onconnect = async () => {
        statusDiv.textContent = "接続成功！";

        // モーターの設定
        servo = obniz.wired("ServoMotor", {
          signal: 0,
          vcc: 1,
          gnd: 2, // GND共通化
        });

        // モーターを初期位置(0度)へ
        await servo.angle(0);

        // 初期状態
        statusDiv.textContent = "じゅんび完了";
        startButton.textContent = "作業をはじめる";
        startButton.disabled = false;
        stopButton.disabled = true;
      };

      // スタートボタンが押された時の処理
      startButton.onclick = async () => {
        isLooping = true;
        startButton.disabled = true;
        stopButton.disabled = false;
        statusDiv.textContent = "作業するのかにゃ";

        while (isLooping) {
          // 1. 10秒待機
          statusDiv.textContent = "作業がんばり中";
          await obniz.wait(10 * 1000);

          if (!isLooping) break;

          //　10秒後の動作
          statusDiv.textContent = "かまえにゃ";
          playRandomCatSound(); // PCで音声再生
          await servo.angle(180);
          await obniz.wait(3 * 1000);
          statusDiv.textContent = "もういいにゃ";
          await obniz.wait(2 * 1000);

          if (!isLooping) break;

          await servo.angle(0);

          // 4. ループの先頭に戻る
        }

        // ループが終了した後の処理
        statusDiv.textContent = "おつかれ";
        startButton.disabled = false;
        stopButton.disabled = true;

        // 停止した時も、念のためモーターを初期位置に戻す
        await servo.angle(0);
      };

      // --- 停止ボタンが押された時の処理 ---
      stopButton.onclick = () => {
        isLooping = false;
        statusDiv.textContent = "さっさとおわるにゃ";
        stopButton.disabled = true;
      };

      // obnizが切断されたら
      obniz.onclose = () => {
        isLooping = false;
        statusDiv.textContent = "ばいばい";
        startButton.textContent = "切断";
        startButton.disabled = true;
        stopButton.disabled = true;
      };
    </script>
  </body>
</html>
