<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>猫の手も借りたい(仮)</title>
    <script src="https://unpkg.com/obniz@3.18.0/obniz.js"></script>
    <style>
      /* --- 基本設定 --- */
      body {
        /* (メイン背景色) */
        background-color: #efeee5;

        /* (メインの文字色) */
        color: #998e77;

        /* UIが美しく見えるモダンなフォントを指定 */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;

        /* 画面全体に中央寄せ (以前のコードから流用) */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }

      /* --- ステータス表示 --- */
      #status {
        font-size: 1.5em;
        font-weight: 600; /* 少し太くして存在感を出す */
        margin-bottom: 25px; /* ボタンとの距離を確保 */
        text-align: center;

        /* (ステータス欄の背景色) */
        background-color: #dfdacc;

        padding: 20px 30px;
        border-radius: 12px; /* 角を丸める */

        /* 柔らかい影を落として立体感を出す */
        box-shadow: 0 4px 12px rgba(153, 142, 119, 0.2);
      }

      /* --- ボタンの共通スタイル --- */
      .button-container {
        display: flex;
        gap: 15px; /* ボタン同士の間隔 */
      }

      .button-container button {
        font-size: 1.2em;
        font-weight: bold; /* 文字を太く */
        padding: 15px 35px; /* 余白を大きく */
        cursor: pointer;
        border: none; /* デフォルトの枠線を消す */
        border-radius: 12px; /* 角を丸める */

        /* 押した感覚を出すための影 */
        box-shadow: 0 4px 15px rgba(153, 142, 119, 0.3);

        /* ホバー時のアニメーション */
        transition: all 0.2s ease-in-out;
      }

      /* ボタンホバー時（マウスが乗った時） */
      .button-container button:not(:disabled):hover {
        transform: translateY(-2px); /* 少し浮き上がる */
        box-shadow: 0 6px 20px rgba(153, 142, 119, 0.35);
      }

      /* ボタンクリック時 */
      .button-container button:not(:disabled):active {
        transform: translateY(1px); /* 少し沈む */
        box-shadow: 0 2px 8px rgba(153, 142, 119, 0.4);
      }

      /* --- スタートボタン --- */
      #startButton {
        /* (スタートボタンの色) */
        background-color: #e2a99d;

        /* (スタートボタンの文字色) */
        color: #ffffff;
      }

      /* --- 停止ボタン --- */
      #stopButton {
        /* (ストップボタンの色) */
        background-color: #d47e7e;
        color: #ffffff;
      }

      /* --- 無効化されたボタン --- */
      .button-container button:disabled {
        /* (無効時の背景色) */
        background-color: #dfdacc;

        /* (無効時の文字色) */
        color: #998e77;

        opacity: 0.7;
        cursor: not-allowed;
        box-shadow: none; /* 無効時は影を消す */
      }
    </style>
  </head>
  <body>
    <div id="status">接続中...</div>
    <div class="button-container">
      <button id="startButton" disabled>作業をはじめる</button>
      <button id="stopButton" disabled>作業をおえる</button>
    </div>

    <script>
      const obniz = new Obniz("2061-9919");

      const TOTAL_SOUND_FILES = 15;
      const FILE_PREFIX = "./voice/cat";
      const FILE_SUFFIX = ".mp3";

      const startButton = document.getElementById("startButton");
      const stopButton = document.getElementById("stopButton");
      const statusDiv = document.getElementById("status");

      let isLooping = false;

      function playRandomCatSound() {
        // 1 から TOTAL_SOUND_FILES までのランダムな整数を生成
        const index = Math.floor(Math.random() * TOTAL_SOUND_FILES) + 1;

        // ファイル名を組み立てる
        const soundFile = FILE_PREFIX + index + FILE_SUFFIX;

        // 選ばれたURLで新しいAudioオブジェクトを作成して再生
        const soundToPlay = new Audio(soundFile);
        soundToPlay.play();
      }

      // obnizが接続されたら
      obniz.onconnect = async () => {
        statusDiv.textContent = "接続成功！";

        // モーターの設定
        servo = obniz.wired("ServoMotor", {
          signal: 0,
          vcc: 1,
          gnd: 2, // GND共通化
        });

        // モーターを初期位置(0度)へ
        await servo.angle(0);

        // 初期状態
        statusDiv.textContent = "じゅんび完了";
        startButton.textContent = "作業をはじめる";
        startButton.disabled = false;
        stopButton.disabled = true;
      };

      // スタートボタンが押された時の処理
      startButton.onclick = async () => {
        isLooping = true;
        startButton.disabled = true;
        stopButton.disabled = false;
        statusDiv.textContent = "作業するのかにゃ";

        while (isLooping) {
          // 1. 10秒待機
          statusDiv.textContent = "作業がんばり中";
          await obniz.wait(10 * 1000);

          if (!isLooping) break;

          //　10秒後の動作
          statusDiv.textContent = "かまえにゃ";
          playRandomCatSound(); // PCで音声再生
          await servo.angle(180);
          await obniz.wait(3 * 1000);
          statusDiv.textContent = "もういいにゃ";
          await obniz.wait(2 * 1000);

          if (!isLooping) break;

          await servo.angle(0);

          // 4. ループの先頭に戻る
        }

        // ループが終了した後の処理
        statusDiv.textContent = "おつかれ";
        startButton.disabled = false;
        stopButton.disabled = true;

        // 停止した時も、念のためモーターを初期位置に戻す
        await servo.angle(0);
      };

      // --- 停止ボタンが押された時の処理 ---
      stopButton.onclick = () => {
        isLooping = false;
        statusDiv.textContent = "さっさとおわるにゃ";
        stopButton.disabled = true;
      };

      // obnizが切断されたら
      obniz.onclose = () => {
        isLooping = false;
        statusDiv.textContent = "ばいばい";
        startButton.textContent = "切断";
        startButton.disabled = true;
        stopButton.disabled = true;
      };
    </script>
  </body>
</html>
